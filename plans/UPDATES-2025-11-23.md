# Planning Documents Updates - 2025-11-23

## Summary of Changes

**Date**: November 23, 2025
**Reason**: Clarify testing stack and tools used across implementation phases

---

## Changes Made

### 1. Testing Strategy Document (`testing-strategy-per-phase.md`)

**Added**: Testing Stack Overview section at the beginning

**Key Clarifications**:
- **Jest** is used for backend tests (Phases M1-M4)
- **Supertest + Jest** for API tests (Phase M5)
- **Playwright** for frontend E2E tests (Phases M6-M7)

**Updates per Phase**:
- Phase M1: Added "Testing Tool: Jest + better-sqlite3"
- Phase M2: Added "Testing Tool: Jest (with mocks for external APIs)"
- Phase M3: Added "Testing Tool: Jest (with mocked LLM responses)"
- Phase M4: Added "Testing Tool: Jest (integration tests)"
- Phase M5: Added "Testing Tool: Supertest + Jest"
- Phase M6: Added "Testing Tool: Playwright + Jest"
- Phase M7: Clarified mix of Jest (backend) and Playwright (frontend)

**File Naming Convention** established:
- `.test.ts` files → Jest tests (backend, API, no browser)
- `.spec.ts` files → Playwright tests (frontend, real browser)

### 2. Testing Quick Reference (`TESTING-QUICK-REFERENCE.md`)

**Added**: Testing Stack table at the top

**Updates**:
- Added tool clarification to each phase heading
- Added inline comments to test commands showing which tool runs
- Examples:
  - `npm run test:m1  # Jest tests for DB schema & repositories`
  - `npm run test:m5:api  # Supertest + Jest (no browser)`
  - `npm run test:m6:e2e  # Playwright (real browser)`

---

## Rationale

### Problem Addressed

The original testing documentation didn't clearly specify **which testing tool to use when**. This could lead to:
- Confusion about when to use Jest vs. Playwright
- Attempting to use Playwright for backend tests (inefficient)
- Not understanding the three-tier testing approach

### Solution

**Three-tier testing approach now explicit**:

```
┌─────────────────────────────────────────┐
│  Tier 1: Backend (Jest)                 │
│  • Database, repositories               │
│  • Tools, agents, workflows             │
│  • Fast, no browser needed              │
│  • Files: *.test.ts                     │
└─────────────────────────────────────────┘
             ↓
┌─────────────────────────────────────────┐
│  Tier 2: API (Supertest + Jest)         │
│  • HTTP endpoint testing                │
│  • Request/response validation          │
│  • No browser, tests Express/Fastify    │
│  • Files: *.test.ts                     │
└─────────────────────────────────────────┘
             ↓
┌─────────────────────────────────────────┐
│  Tier 3: Frontend (Playwright)          │
│  • Real browser E2E tests               │
│  • User flows and interactions          │
│  • Full integration testing             │
│  • Files: *.spec.ts                     │
└─────────────────────────────────────────┘
```

---

## Impact on Implementation

### Existing Tests (47 Playwright Tests)

**No changes required** - Your existing 47 Playwright tests continue to work:

```
tests/
├── TEST-001-brand-setup.spec.ts          ✅ Keep (Playwright)
├── TEST-002-persona-creation.spec.ts     ✅ Keep (Playwright)
├── ...
└── TEST-012-ai-content.spec.ts           ✅ Keep (Playwright)
```

### New Tests to Add

**Backend tests** (Jest):
```
tests/
├── unit/
│   ├── db/                    # Phase M1 (Jest)
│   ├── tools/                 # Phase M2 (Jest)
│   └── agents/                # Phase M3 (Jest)
├── integration/
│   ├── tools/                 # Phase M2 (Jest)
│   ├── workflows/             # Phase M4 (Jest)
│   └── frontend-deps.test.ts  # Phase M6 (Jest)
└── api/                       # Phase M5 (Supertest + Jest)
    ├── brands.api.test.ts
    └── cards.api.test.ts
```

**Frontend E2E tests** (Playwright):
```
tests/
└── e2e/
    └── frontend/              # Phase M6 (Playwright)
        ├── brand-setup-flow.spec.ts
        ├── card-generation-flow.spec.ts
        └── card-gallery-flow.spec.ts
```

---

## Installation Requirements

### Already Installed ✅

You already have these in `package.json`:
- `jest: ^30.2.0`
- `@playwright/test: ^1.56.1`
- `ts-jest: ^29.4.5`

### Need to Add

```bash
# For API testing (Phase M5)
npm install -D supertest @types/supertest

# For database testing (Phase M1)
npm install -D better-sqlite3 @types/better-sqlite3
```

---

## Test Script Configuration

### Updated `package.json` Scripts

The testing strategy documents now specify these scripts:

```json
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:e2e": "playwright test",  // Existing Playwright tests

    "test:m1": "jest tests/unit/db",
    "test:m2": "jest tests/unit/tools tests/integration/tools",
    "test:m3": "jest tests/unit/agents",
    "test:m4": "jest tests/integration/workflows tests/e2e/workflows",
    "test:m5": "jest tests/api",
    "test:m6": "playwright test tests/e2e/frontend && jest tests/integration/frontend-deps",
    "test:m7": "jest tests/prd/*.test.ts && playwright test tests/prd/*.spec.ts",

    "validate:m1": "tsx scripts/validate-m1.ts",
    "validate:m2": "tsx scripts/validate-m2.ts",
    // ... (validate scripts for M3-M7)
  }
}
```

---

## Key Decisions Documented

### Decision 1: Jest for Backend
**Rationale**:
- Fast execution without browser overhead
- Excellent mocking support (fal.ai, LLM APIs)
- In-memory database testing (SQLite :memory:)
- Already installed and configured

### Decision 2: Supertest for API
**Rationale**:
- Tests HTTP APIs without starting server
- Works with Express/Fastify
- Validates request/response contracts
- No browser needed (faster than Playwright)

### Decision 3: Playwright for Frontend
**Rationale**:
- Already have 47 working tests
- Tests real browser interactions
- Validates full user flows
- Required for TEST-101, TEST-103 (PRD requirements)

### Decision 4: File Naming Convention
**Rationale**:
- `.test.ts` → Jest (convention in Jest community)
- `.spec.ts` → Playwright (convention in E2E community)
- Clear separation prevents confusion
- IDE can run appropriate test runner

---

## Example Test Flow

### Backend Test (Jest)

```typescript
// tests/unit/db/schema.test.ts
import { describe, test, expect } from '@jest/globals';
import { setupTestDb } from '../../helpers/db-test-helper';

describe('Database Schema', () => {
  test('TEST-M1-001: All 6 tables should exist', () => {
    const { db, cleanup } = setupTestDb();
    // Test schema
    cleanup();
  });
});
```

**Run**: `npm run test:m1`

### API Test (Supertest + Jest)

```typescript
// tests/api/brands.api.test.ts
import request from 'supertest';
import { app } from '../../../app/server';

test('TEST-M5-001: POST /api/brands should create brand', async () => {
  const response = await request(app)
    .post('/api/brands')
    .send({ name: 'Test Brand' })
    .expect(201);

  expect(response.body.brandId).toBeDefined();
});
```

**Run**: `npm run test:m5:api`

### Frontend E2E Test (Playwright)

```typescript
// tests/e2e/frontend/brand-setup-flow.spec.ts
import { test, expect } from '@playwright/test';

test('TEST-M6-001: Should create brand via UI', async ({ page }) => {
  await page.goto('/brand/setup');
  await page.fill('[name="brandName"]', 'FlowForm');
  await page.click('button[type="submit"]');
  await expect(page.getByText('Success')).toBeVisible();
});
```

**Run**: `npm run test:m6:e2e`

---

## Documents Updated

1. ✅ `testing-strategy-per-phase.md` - Added testing stack overview, clarified tool per phase
2. ✅ `TESTING-QUICK-REFERENCE.md` - Added testing stack table, annotated commands
3. ✅ `README.md` - Updated to reference new testing documents

---

## No Changes Required To

- `wisdom-pixels-mastra-flux2-react-plan.md` (PRD)
- `wisdom-pixels-prd-addendum-v2.md` (Addendum)
- `wisdom-pixels-execution-plan-v2.md` (Execution Plan)

These documents already implied the testing stack but didn't explicitly state it. The testing strategy documents now make it crystal clear.

---

## Benefits of These Updates

1. **Clarity**: Developers know exactly which tool to use when
2. **Efficiency**: No wasted time trying to use Playwright for backend tests
3. **Consistency**: File naming convention prevents confusion
4. **Speed**: Jest tests run much faster than Playwright for backend
5. **Maintainability**: Clear separation of concerns

---

## Next Steps

1. **Install missing dependencies**:
   ```bash
   npm install -D supertest @types/supertest better-sqlite3 @types/better-sqlite3
   ```

2. **Start Phase M1** with confidence:
   ```bash
   npm run test:m1  # Jest tests for database
   npm run validate:m1
   ```

3. **Reference** the updated documents:
   - Quick commands: `TESTING-QUICK-REFERENCE.md`
   - Detailed examples: `testing-strategy-per-phase.md`
   - Overview: `README.md`

---

**Update Complete**: ✅
**Document Status**: Ready for Phase M1 implementation
**Last Updated**: 2025-11-23
